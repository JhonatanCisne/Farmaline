<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Farmaline</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../CSS/admin.css" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <div class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../images/farmaline-logo.png" alt="Farmaline Logo" height="40" class="mb-2">
            <h4>ADMIN PANEL</h4>
        </div>
        
        <nav class="sidebar-nav">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#inicio" data-section="inicio">
                        <i class="fas fa-home"></i>
                        <span>Inicio</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#productos" data-section="productos">
                        <i class="fas fa-pills"></i>
                        <span>Productos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#repartidores" data-section="repartidores">
                        <i class="fas fa-truck"></i>
                        <span>Repartidores</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="sidebar-footer">
            <a href="../HTML/Index.html" class="btn btn-outline-light btn-sm w-100 mb-2">
                <i class="fas fa-home"></i> <span>Volver al sitio</span>
            </a>
            <a href="#" class="btn btn-danger btn-sm w-100" id="logout">
                <i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
        <!-- Header -->
        <header class="admin-header">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary me-3" id="toggle-sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 class="mb-0" id="page-title">Inicio</h2>
                </div>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-teal dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> Administrador
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="logout-header"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Inicio Section -->
            <div class="content-section active" id="inicio-section">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card clickable-card" data-action="productos" data-filter="">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 id="total-productos" class="mb-1">0</h3>
                                        <p class="mb-0">Total Productos</p>
                                    </div>
                                    <div>
                                        <i class="fas fa-pills fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card danger clickable-card" data-action="productos" data-filter="critico">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 id="stock-critico" class="mb-1">0</h3>
                                        <p class="mb-0">Stock Crítico (≤10)</p>
                                    </div>
                                    <div>
                                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card warning clickable-card" data-action="productos" data-filter="bajo">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 id="stock-bajo" class="mb-1">0</h3>
                                        <p class="mb-0">Stock Bajo (11-20)</p>
                                    </div>
                                    <div>
                                        <i class="fas fa-exclamation-circle fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card info clickable-card" data-action="repartidores" data-filter="">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 id="total-repartidores" class="mb-1">0</h3>
                                        <p class="mb-0">Repartidores</p>
                                    </div>
                                    <div>
                                        <i class="fas fa-truck fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos Section -->
            <div class="content-section" id="productos-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Gestión de Productos</h3>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Filtrar por Categoría</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-2 mb-2">
                                        <button class="btn btn-outline-teal w-100 category-btn active" data-category="">
                                            Todas
                                        </button>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <button class="btn btn-outline-teal w-100 category-btn" data-category="medicamentos">
                                            Medicamentos
                                        </button>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <button class="btn btn-outline-teal w-100 category-btn" data-category="vitaminas">
                                            Vitaminas
                                        </button>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <button class="btn btn-outline-teal w-100 category-btn" data-category="cuidado-personal">
                                            Cuidado Personal
                                        </button>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <button class="btn btn-outline-teal w-100 category-btn" data-category="bebes">
                                            Bebés
                                        </button>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <button class="btn btn-outline-teal w-100 category-btn" data-category="fotoproteccion">
                                            Fotoprotección
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Lista de Productos <span id="filter-indicator"></span></h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Stock</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-productos">
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Repartidores Section -->
            <div class="content-section" id="repartidores-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Gestión de Repartidores</h3>
                    <button class="btn btn-teal" data-bs-toggle="modal" data-bs-target="#modalRepartidor">
                        <i class="fas fa-user-plus"></i> Nuevo Repartidor
                    </button>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Lista de Repartidores</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Teléfono</th>
                                        <th>Zona</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-repartidores">
                                    <!-- Se carga dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Actualizar Stock -->
    <div class="modal fade" id="modalStock" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle me-2"></i>
                        Actualizar Stock
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formStock">
                        <input type="hidden" id="producto-id-stock">
                        <div class="mb-3">
                            <label for="producto-nombre-stock" class="form-label">Producto</label>
                            <input type="text" class="form-control" id="producto-nombre-stock" readonly>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="stock-actual" class="form-label">Stock Actual</label>
                                    <input type="number" class="form-control" id="stock-actual" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cantidad-agregar" class="form-label">Cantidad a Agregar</label>
                                    <input type="number" class="form-control" id="cantidad-agregar" min="1" value="10" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="stock-nuevo" class="form-label">Stock Nuevo</label>
                            <input type="number" class="form-control bg-light" id="stock-nuevo" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-teal" id="confirmar-stock">Actualizar Stock</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Repartidor -->
    <div class="modal fade" id="modalRepartidor" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>
                        Nuevo Repartidor
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formRepartidor">
                        <div class="mb-3">
                            <label for="repartidor-nombre" class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="repartidor-nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="repartidor-telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="repartidor-telefono" required>
                        </div>
                        <div class="mb-3">
                            <label for="repartidor-zona" class="form-label">Zona de Trabajo</label>
                            <select class="form-select" id="repartidor-zona" required>
                                <option value="">Seleccione una zona...</option>
                                <option value="norte">Zona Norte</option>
                                <option value="sur">Zona Sur</option>
                                <option value="este">Zona Este</option>
                                <option value="oeste">Zona Oeste</option>
                                <option value="centro">Centro</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-teal" id="confirmar-repartidor">Crear Repartidor</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../JS/products.js"></script>
    <script>
        // Admin Panel Simple
        class AdminPanel {
            constructor() {
                this.productos = products || []
                this.repartidores = JSON.parse(localStorage.getItem('farmaline_repartidores') || '[]')
                this.currentSection = 'inicio'
                this.currentCategory = ''
                this.currentStockFilter = ''
                this.init()
            }

            init() {
                this.setupEventListeners()
                this.actualizarDashboard()
                this.cargarTablaProductos()
                this.cargarTablaRepartidores()
            }

            setupEventListeners() {
                // Navegación
                document.querySelectorAll('.sidebar-nav .nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault()
                        const section = e.target.closest('.nav-link').dataset.section
                        this.cambiarSeccion(section)
                    })
                })

                // Cards clickeables del dashboard
                document.querySelectorAll('.clickable-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const action = card.dataset.action
                        const filter = card.dataset.filter
                        this.navegarDesdeCard(action, filter)
                    })
                })

                // Toggle sidebar
                document.getElementById('toggle-sidebar').addEventListener('click', () => {
                    this.toggleSidebar()
                })

                // Filtros de categoría
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const category = e.target.dataset.category
                        this.filtrarPorCategoria(category)
                    })
                })

                // Modales
                document.getElementById('confirmar-stock').addEventListener('click', () => {
                    this.confirmarActualizacionStock()
                })

                document.getElementById('confirmar-repartidor').addEventListener('click', () => {
                    this.confirmarNuevoRepartidor()
                })

                document.getElementById('cantidad-agregar').addEventListener('input', () => {
                    this.calcularStockNuevo()
                })

                // Logout
                document.getElementById('logout').addEventListener('click', (e) => {
                    e.preventDefault()
                    this.logout()
                })

                document.getElementById('logout-header').addEventListener('click', (e) => {
                    e.preventDefault()
                    this.logout()
                })
            }

            navegarDesdeCard(action, filter) {
                if (action === 'productos') {
                    this.currentStockFilter = filter
                    this.cambiarSeccion('productos')
                    this.aplicarFiltroStock(filter)
                } else if (action === 'repartidores') {
                    this.cambiarSeccion('repartidores')
                }
            }

            aplicarFiltroStock(filter) {
                this.currentStockFilter = filter
                
                // Limpiar filtros de categoría
                this.currentCategory = ''
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active')
                })
                document.querySelector('[data-category=""]').classList.add('active')
                
                // Actualizar indicador de filtro
                const indicator = document.getElementById('filter-indicator')
                if (filter === 'critico') {
                    indicator.innerHTML = '<span class="badge bg-danger ms-2">Stock Crítico (≤10)</span>'
                } else if (filter === 'bajo') {
                    indicator.innerHTML = '<span class="badge bg-warning text-dark ms-2">Stock Bajo (11-20)</span>'
                } else {
                    indicator.innerHTML = ''
                }
                
                this.cargarTablaProductos()
            }

            cambiarSeccion(section) {
                document.querySelectorAll('.sidebar-nav .nav-link').forEach(link => {
                    link.classList.remove('active')
                })
                document.querySelector(`[data-section="${section}"]`).classList.add('active')

                document.querySelectorAll('.content-section').forEach(sec => {
                    sec.classList.remove('active')
                })
                document.getElementById(`${section}-section`).classList.add('active')

                const titles = {
                    inicio: 'Inicio',
                    productos: 'Productos',
                    repartidores: 'Repartidores'
                }
                document.getElementById('page-title').textContent = titles[section]
                this.currentSection = section

                // Limpiar filtros al cambiar de sección
                if (section !== 'productos') {
                    this.currentStockFilter = ''
                    document.getElementById('filter-indicator').innerHTML = ''
                }
            }

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar')
                const mainContent = document.getElementById('main-content')
                sidebar.classList.toggle('collapsed')
                mainContent.classList.toggle('expanded')
            }

            actualizarDashboard() {
                const totalProductos = this.productos.length
                const stockCritico = this.productos.filter(p => p.stock <= 10).length
                const stockBajo = this.productos.filter(p => p.stock > 10 && p.stock <= 20).length
                const totalRepartidores = this.repartidores.length

                document.getElementById('total-productos').textContent = totalProductos
                document.getElementById('stock-critico').textContent = stockCritico
                document.getElementById('stock-bajo').textContent = stockBajo
                document.getElementById('total-repartidores').textContent = totalRepartidores
            }

            filtrarPorCategoria(category) {
                this.currentCategory = category
                this.currentStockFilter = '' // Limpiar filtro de stock
                document.getElementById('filter-indicator').innerHTML = ''
                
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active')
                })
                document.querySelector(`[data-category="${category}"]`).classList.add('active')
                
                this.cargarTablaProductos()
            }

            cargarTablaProductos() {
                const tbody = document.getElementById('tabla-productos')
                let productosFiltrados = this.productos

                // Filtrar por categoría
                if (this.currentCategory) {
                    productosFiltrados = productosFiltrados.filter(p => p.category === this.currentCategory)
                }

                // Filtrar por stock
                if (this.currentStockFilter === 'critico') {
                    productosFiltrados = productosFiltrados.filter(p => p.stock <= 10)
                } else if (this.currentStockFilter === 'bajo') {
                    productosFiltrados = productosFiltrados.filter(p => p.stock > 10 && p.stock <= 20)
                }

                tbody.innerHTML = productosFiltrados.map(p => `
                    <tr>
                        <td><strong>#${p.id}</strong></td>
                        <td>${p.name}</td>
                        <td>
                            <span class="badge ${this.getStockBadgeClass(p.stock)}">${p.stock}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-teal" onclick="adminPanel.abrirModalStock(${p.id})">
                                <i class="fas fa-plus"></i> Aumentar
                            </button>
                        </td>
                    </tr>
                `).join('')

                if (productosFiltrados.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-2"></i><br>
                                No se encontraron productos con los filtros aplicados
                            </td>
                        </tr>
                    `
                }
            }

            cargarTablaRepartidores() {
                const tbody = document.getElementById('tabla-repartidores')
                
                if (this.repartidores.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                <i class="fas fa-truck fa-2x mb-2"></i><br>
                                No hay repartidores registrados
                            </td>
                        </tr>
                    `
                } else {
                    tbody.innerHTML = this.repartidores.map(r => `
                        <tr>
                            <td><strong>#${r.id}</strong></td>
                            <td>${r.nombre}</td>
                            <td>${r.telefono}</td>
                            <td>${this.getZonaName(r.zona)}</td>
                            <td><span class="badge bg-success">Activo</span></td>
                        </tr>
                    `).join('')
                }
            }

            abrirModalStock(productoId) {
                const producto = this.productos.find(p => p.id === productoId)
                if (producto) {
                    document.getElementById('producto-id-stock').value = producto.id
                    document.getElementById('producto-nombre-stock').value = producto.name
                    document.getElementById('stock-actual').value = producto.stock
                    document.getElementById('cantidad-agregar').value = 10
                    this.calcularStockNuevo()

                    const modal = new bootstrap.Modal(document.getElementById('modalStock'))
                    modal.show()
                }
            }

            calcularStockNuevo() {
                const stockActual = parseInt(document.getElementById('stock-actual').value) || 0
                const cantidadAgregar = parseInt(document.getElementById('cantidad-agregar').value) || 0
                document.getElementById('stock-nuevo').value = stockActual + cantidadAgregar
            }

            confirmarActualizacionStock() {
                const productoId = parseInt(document.getElementById('producto-id-stock').value)
                const cantidadAgregar = parseInt(document.getElementById('cantidad-agregar').value)

                const producto = this.productos.find(p => p.id === productoId)
                if (producto && cantidadAgregar > 0) {
                    producto.stock += cantidadAgregar
                    
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('modalStock'))
                    modalInstance.hide()
                    
                    this.actualizarDashboard()
                    this.cargarTablaProductos()
                    
                    this.mostrarNotificacion(`Stock de ${producto.name} actualizado`, 'success')
                }
            }

            confirmarNuevoRepartidor() {
                const nombre = document.getElementById('repartidor-nombre').value
                const telefono = document.getElementById('repartidor-telefono').value
                const zona = document.getElementById('repartidor-zona').value

                if (nombre && telefono && zona) {
                    const nuevoRepartidor = {
                        id: this.repartidores.length + 1,
                        nombre,
                        telefono,
                        zona
                    }

                    this.repartidores.push(nuevoRepartidor)
                    localStorage.setItem('farmaline_repartidores', JSON.stringify(this.repartidores))

                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('modalRepartidor'))
                    modalInstance.hide()

                    document.getElementById('formRepartidor').reset()
                    this.actualizarDashboard()
                    this.cargarTablaRepartidores()
                    
                    this.mostrarNotificacion(`Repartidor ${nombre} creado`, 'success')
                }
            }

            getStockBadgeClass(stock) {
                if (stock <= 10) return 'bg-danger'
                if (stock <= 20) return 'bg-warning text-dark'
                return 'bg-success'
            }

            getZonaName(zona) {
                const zonas = {
                    norte: 'Zona Norte',
                    sur: 'Zona Sur',
                    este: 'Zona Este',
                    oeste: 'Zona Oeste',
                    centro: 'Centro'
                }
                return zonas[zona] || zona
            }

            mostrarNotificacion(mensaje, tipo = 'info') {
                const notification = document.createElement('div')
                notification.className = `alert alert-${tipo} position-fixed`
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;'
                notification.innerHTML = `${mensaje} <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>`
                
                document.body.appendChild(notification)
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove()
                    }
                }, 3000)
            }

            logout() {
                if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                    window.location.href = '../HTML/Index.html'
                }
            }
        }

        // Inicializar
        let adminPanel
        document.addEventListener('DOMContentLoaded', () => {
            adminPanel = new AdminPanel()
        })
    </script>
</body>
</html>
